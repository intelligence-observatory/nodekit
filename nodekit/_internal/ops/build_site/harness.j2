<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NodeKit</title>
    <link rel="shortcut icon" href="">

    <!-- NodeKit -->
    <script src="{{ js_path }}"></script>
    <link href="{{ css_path }}" rel="stylesheet">

    <script>
        function showOverlay({ title, message, details, showCopy = true }) {
            if (typeof window === "undefined" || !window.document) {
                return null
            }

            const existing = document.getElementById("nk-overlay");
            if (existing) {
                existing.remove();
            }

            const overlay = document.createElement("div");
            overlay.id = "nk-overlay";
            Object.assign(overlay.style, {
                position: "fixed",
                inset: "0",
                background: "rgba(250, 250, 250, 0.98)",
                color: "#111",
                fontFamily: "sans-serif",
                padding: "2rem",
                overflow: "auto",
                zIndex: "9999",
            });

            const card = document.createElement("div");
            Object.assign(card.style, {
                maxWidth: "720px",
                margin: "10vh auto",
                background: "white",
                border: "1px solid #ddd",
                borderRadius: "10px",
                padding: "1.5rem",
                boxShadow: "0 6px 24px rgba(0,0,0,0.08)",
            });

            const titleEl = document.createElement("div");
            titleEl.textContent = title;
            Object.assign(titleEl.style, {
                fontSize: "1.4rem",
                fontWeight: "600",
                marginBottom: "0.75rem",
            });

            const messageEl = document.createElement("div");
            messageEl.textContent = message;
            Object.assign(messageEl.style, {
                marginBottom: "1rem",
                lineHeight: "1.5",
            });

            card.appendChild(titleEl);
            card.appendChild(messageEl);

            let detailsEl = null;
            if (details) {
                detailsEl = document.createElement("textarea");
                detailsEl.readOnly = true;
                detailsEl.value = details;
                Object.assign(detailsEl.style, {
                    width: "100%",
                    minHeight: "220px",
                    fontFamily: "ui-monospace, SFMono-Regular, Menlo, Consolas, monospace",
                    fontSize: "0.85rem",
                    border: "1px solid #ddd",
                    borderRadius: "6px",
                    padding: "0.75rem",
                    boxSizing: "border-box",
                    background: "#fafafa",
                    color: "#111",
                });
                card.appendChild(detailsEl);
            }

            if (showCopy && detailsEl) {
                const btn = document.createElement("button");
                btn.textContent = "Copy error report";
                Object.assign(btn.style, {
                    marginTop: "0.75rem",
                    padding: "0.6rem 0.9rem",
                    borderRadius: "6px",
                    border: "1px solid #ccc",
                    background: "#f4f4f4",
                    cursor: "pointer",
                });
                btn.onclick = async () => {
                    detailsEl.select();
                    detailsEl.setSelectionRange(0, detailsEl.value.length);
                    try {
                        await navigator.clipboard.writeText(detailsEl.value);
                        btn.textContent = "Copied";
                        setTimeout(() => {
                            btn.textContent = "Copy error report";
                        }, 1500);
                    } catch (e) {
                        btn.textContent = "Copy failed";
                    }
                };
                card.appendChild(btn);
            }

            overlay.appendChild(card);
            document.body.appendChild(overlay);
        }

        function formatErrorReport(err, context) {
            const parts = [];
            parts.push("NodeKit Error Report");
            parts.push(`timestamp: ${new Date().toISOString()}`);
            parts.push(`url: ${typeof window !== "undefined" ? window.location.href : "unknown"}`);
            parts.push(`userAgent: ${typeof navigator !== "undefined" ? navigator.userAgent : "unknown"}`);
            parts.push(`context: ${JSON.stringify(context ?? null, null, 2)}`);

            if (err) {
                const name = err.name || "Error";
                const message = err.message || String(err);
                parts.push(`errorName: ${name}`);
                parts.push(`errorMessage: ${message}`);
                if (err.stack) {
                    parts.push("stack:");
                    parts.push(err.stack);
                }
            } else {
                parts.push("error: unknown");
            }

            return parts.join("\n");
        }
    </script>

    <script>
        function isMturkPreviewMode() {
            if (typeof window === "undefined" || !window.location) {
                return false;
            }

            const params = new URLSearchParams(window.location.search);
            const assignmentId = params.get("assignmentId");
            const PREVIEW_SENTINEL = "ASSIGNMENT_ID_NOT_AVAILABLE";

            return assignmentId === PREVIEW_SENTINEL;
        }

        function addPreviewSplash() {
            showOverlay({
                title: "Preview Mode",
                message: "Accept the HIT to continue.",
                showCopy: false,
            });
        }
    </script>

    <script>
        const graph = {{ graph | tojson(indent=4) | indent(8, first=False) }};

        window.onload = async () => {
            await NodeKit.play(graph);
        };
    </script>
</head>
<body></body>
</html>
