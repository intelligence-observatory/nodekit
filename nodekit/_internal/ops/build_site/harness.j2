<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NodeKit</title>
    <link rel="shortcut icon" href="">

    <!-- NodeKit -->
    <script src="{{ js_path }}"></script>
    <link href="{{ css_path }}" rel="stylesheet">


    <script>
        function tryInferTurkContext() {
            if (typeof window === "undefined" || !window.location) {
                return null
            }

            const params = new URLSearchParams(window.location.search);

            // MTurk-style query params
            const assignmentId = params.get("assignmentId");
            const hitId = params.get("hitId");
            const workerId = params.get("workerId");
            const turkSubmitTo = params.get("turkSubmitTo");

            const looksLikeMTurk =
                assignmentId !== null ||
                hitId !== null ||
                workerId !== null ||
                turkSubmitTo !== null;

            if (!looksLikeMTurk) {
                return null
            }

            // Preview mode per MTurk docs: assignmentId is present and equals this sentinel.
            const PREVIEW_SENTINEL = "ASSIGNMENT_ID_NOT_AVAILABLE";
            const preview_mode = assignmentId === PREVIEW_SENTINEL;

            if (preview_mode) {
                return {
                    previewMode: true,
                    context: null,
                };
            }

            // Not previewing â†’ require all fields
            if (!turkSubmitTo || !hitId || !assignmentId || !workerId) {
                const e = new Error("Missing required parameters in the query for MTurk platform.");
                e.name = "BadPlatformContextError";
                throw e;
            }

            return {
                previewMode: false,
                context: {
                    assignmentId: assignmentId,
                    turkSubmitTo: turkSubmitTo,
                    workerId: workerId,
                },
            };
        }
    </script>
    <script>
        function addPreviewSplash(){
            if (typeof window === "undefined" || !window.location) {
                return null
            }
            showOverlay({
                title: "Preview Mode",
                message: "Accept the HIT to continue. After accepting, refresh this page.",
                showCopy: false,
            });
        }
    </script>
    <script>
        function showOverlay({ title, message, details, showCopy = true }) {
            if (typeof window === "undefined" || !window.document) {
                return null
            }

            const existing = document.getElementById("nk-overlay");
            if (existing) {
                existing.remove();
            }

            const overlay = document.createElement("div");
            overlay.id = "nk-overlay";
            Object.assign(overlay.style, {
                position: "fixed",
                inset: "0",
                background: "rgba(250, 250, 250, 0.98)",
                color: "#111",
                fontFamily: "sans-serif",
                padding: "2rem",
                overflow: "auto",
                zIndex: "9999",
            });

            const card = document.createElement("div");
            Object.assign(card.style, {
                maxWidth: "720px",
                margin: "10vh auto",
                background: "white",
                border: "1px solid #ddd",
                borderRadius: "10px",
                padding: "1.5rem",
                boxShadow: "0 6px 24px rgba(0,0,0,0.08)",
            });

            const titleEl = document.createElement("div");
            titleEl.textContent = title;
            Object.assign(titleEl.style, {
                fontSize: "1.4rem",
                fontWeight: "600",
                marginBottom: "0.75rem",
            });

            const messageEl = document.createElement("div");
            messageEl.textContent = message;
            Object.assign(messageEl.style, {
                marginBottom: "1rem",
                lineHeight: "1.5",
            });

            card.appendChild(titleEl);
            card.appendChild(messageEl);

            let detailsEl = null;
            if (details) {
                detailsEl = document.createElement("textarea");
                detailsEl.readOnly = true;
                detailsEl.value = details;
                Object.assign(detailsEl.style, {
                    width: "100%",
                    minHeight: "220px",
                    fontFamily: "ui-monospace, SFMono-Regular, Menlo, Consolas, monospace",
                    fontSize: "0.85rem",
                    border: "1px solid #ddd",
                    borderRadius: "6px",
                    padding: "0.75rem",
                    boxSizing: "border-box",
                    background: "#fafafa",
                    color: "#111",
                });
                card.appendChild(detailsEl);
            }

            if (showCopy && detailsEl) {
                const btn = document.createElement("button");
                btn.textContent = "Copy error report";
                Object.assign(btn.style, {
                    marginTop: "0.75rem",
                    padding: "0.6rem 0.9rem",
                    borderRadius: "6px",
                    border: "1px solid #ccc",
                    background: "#f4f4f4",
                    cursor: "pointer",
                });
                btn.onclick = async () => {
                    detailsEl.select();
                    detailsEl.setSelectionRange(0, detailsEl.value.length);
                    try {
                        await navigator.clipboard.writeText(detailsEl.value);
                        btn.textContent = "Copied";
                        setTimeout(() => {
                            btn.textContent = "Copy error report";
                        }, 1500);
                    } catch (e) {
                        btn.textContent = "Copy failed";
                    }
                };
                card.appendChild(btn);
            }

            overlay.appendChild(card);
            document.body.appendChild(overlay);
        }

        function formatErrorReport(err, context) {
            const parts = [];
            parts.push("NodeKit Error Report");
            parts.push(`timestamp: ${new Date().toISOString()}`);
            parts.push(`url: ${typeof window !== "undefined" ? window.location.href : "unknown"}`);
            parts.push(`userAgent: ${typeof navigator !== "undefined" ? navigator.userAgent : "unknown"}`);
            parts.push(`context: ${JSON.stringify(context ?? null, null, 2)}`);

            if (err) {
                const name = err.name || "Error";
                const message = err.message || String(err);
                parts.push(`errorName: ${name}`);
                parts.push(`errorMessage: ${message}`);
                if (err.stack) {
                    parts.push("stack:");
                    parts.push(err.stack);
                }
            } else {
                parts.push("error: unknown");
            }

            return parts.join("\n");
        }
    </script>

    <script>
        function submitToTurk(
            trace,
            assignmentId,
            turkSubmitTo,
        ){
            // Submission procedure for Mechanical Turk. See: https://docs.aws.amazon.com/AWSMechTurk/latest/AWSMechanicalTurkRequester/mturk-hits-defining-questions-html-javascript.html
            // Note the following undocumented gotcha: the form must have at least one input element other than assignmentId, otherwise
            // Mechanical Turk will not accept the submission. Here, we have the input element `sessionId`, which satisfies this requirement.

            // Get context variables:

            // create the form element and point it to the correct endpoint
            const form = document.createElement('form')
            form.action = (new URL('mturk/externalSubmit', turkSubmitTo)).href
            form.method = 'post'

            // attach the assignmentId
            const inputAssignmentId = document.createElement('input')
            inputAssignmentId.name = 'assignmentId'
            inputAssignmentId.value = assignmentId
            inputAssignmentId.hidden = true
            form.appendChild(inputAssignmentId)

            // attach a runId to allow for Experimenters to map HITs to Sessions
            const inputRunId = document.createElement('input')
            inputRunId.name = 'trace';
            inputRunId.value = JSON.stringify(trace);
            inputRunId.hidden = true;
            form.appendChild(inputRunId)

            // attach the form to the HTML document and trigger submission
            document.body.appendChild(form)

            // Submit the form
            form.submit()
        }
    </script>

    <script>
        const graph = {{ graph | tojson(indent=4) | indent(8, first=False) }};

        window.onload = async () => {
            try {
                // Infer the context:
                const turkContext = tryInferTurkContext()

                // Guard execution if in preview mode
                if (turkContext && turkContext.previewMode === true){
                    addPreviewSplash()
                    return
                }

                // Play the Graph:
                const trace = await NodeKit.play(graph);

                // Handle close down procedures, based on the inferred context:
                if(turkContext && turkContext.previewMode === false){
                    submitToTurk(
                        trace,
                        turkContext.context.assignmentId,
                        turkContext.context.turkSubmitTo,
                    )
                }
            } catch (err) {
                const context = {};
                try {
                    context.turkContext = tryInferTurkContext();
                } catch (e) {
                    context.turkContext = { error: String(e) };
                }

                const report = formatErrorReport(err, context);
                showOverlay({
                    title: "Something went wrong",
                    message: "Please copy the error report below and email it to the requester.",
                    details: report,
                    showCopy: true,
                });
            }
        };
    </script>
</head>
<body></body>
</html>
