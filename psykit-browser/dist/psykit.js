(function(n,t){typeof exports=="object"&&typeof module<"u"?t(exports):typeof define=="function"&&define.amd?define(["exports"],t):(n=typeof globalThis<"u"?globalThis:n||self,t(n.EventClient={}))})(this,(function(n){"use strict";var l=Object.defineProperty;var d=(n,t,u)=>t in n?l(n,t,{enumerable:!0,configurable:!0,writable:!0,value:u}):n[t]=u;var o=(n,t,u)=>d(n,typeof t!="symbol"?t+"":t,u);class t{constructor(e,i){o(this,"connectionUrl");o(this,"runId");o(this,"queue",[]);o(this,"flushing",!1);o(this,"maxRetries",5);if(this.connectionUrl=i,this.runId=e,!this.connectionUrl)throw new Error("connectionUrl is required");if(!this.runId)throw new Error("runId is required")}async queueEvent(e){return new Promise((i,r)=>{this.queue.push({event:e,resolve:i,reject:r,attempts:0}),this._maybeFlushNext()})}_maybeFlushNext(){if(this.flushing)return;const e=this.queue.shift();if(!e)return;this.flushing=!0,console.log(`Flushing event: ${e.event.event_type} (attempt ${e.attempts+1})`),this._postEvent(e.event).then(r=>{e.resolve(r),this.flushing=!1,this._maybeFlushNext()}).catch(r=>{if(e.attempts+=1,e.attempts>=this.maxRetries)e.reject(new Error(`Retry limit exceeded after ${this.maxRetries} retries`));else{const s=Math.pow(2,e.attempts)*100;setTimeout(()=>{this.queue.unshift(e),this.flushing=!1,this._maybeFlushNext()},s)}})}async _postEvent(e){const i=new AbortController,r=setTimeout(()=>i.abort(),5e3);let s;try{s=await fetch(this.connectionUrl,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"},keepalive:!0,signal:i.signal})}catch(h){throw new Error(`Fetch error: ${h}`)}finally{clearTimeout(r)}if(!s.ok)throw new Error(`Protocol error: got bad response: ${s.status} ${s.statusText}`);let a;if((s.headers.get("content-type")||"").includes("application/json"))a=await s.json();else throw new Error(`Protocol error: expected Content-Type application/json: ${s.status} ${s.statusText}`);return{response:a,status:s.status,ok:s.ok}}getEventId(){return crypto.randomUUID()}getTimestamp(){return new Date().toISOString()}async sendStartEvent(){let e={run_id:this.runId,event_id:this.getEventId(),event_type:"StartEvent",event_payload:{},event_timestamp:this.getTimestamp()};return this.queueEvent(e)}async sendNodeResultEvent(e){const i={run_id:this.runId,event_id:this.getEventId(),event_type:"NodeResultEvent",event_payload:e,event_timestamp:this.getTimestamp()};return this.queueEvent(i)}async sendEndEvent(){let e={run_id:this.runId,event_id:this.getEventId(),event_type:"EndEvent",event_payload:{},event_timestamp:this.getTimestamp()};return this.queueEvent(e)}}typeof window<"u"&&(window.EventClient=t),n.EventClient=t,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})}));
