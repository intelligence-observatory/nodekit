<!-- example.html -->
<!doctype html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>NodeKit Browser</title>
</head>
<body>
<div id="app"></div>
<script type="module" src="src/main.ts"></script>
<script type="module">
    // Dev-only safety net for rejected promises
    window.addEventListener('unhandledrejection', (ev) => {
        ev.preventDefault();
        console.error('Unhandled rejection in dev harness:', ev.reason);
        if (ev.reason?.stack) {
            console.error(ev.reason.stack);
        }
    });

    const compositeCard2 = {
        "card_type": "CompositeCard",
        "children": {
            'child-card-11': {
                "card_type": "TextCard",
                "region": {
                    "x": -400,
                    "y": -250,
                    "w": 200,
                    "h": 100,
                    "mask": 'rectangle',
                },
                "text": "I am a child 1 of 2 of the CompositeCard.",
                "font_size": 10,
                "justification_horizontal": "center",
                "justification_vertical": "center",
                "text_color": "#000000ff",
                "background_color": "#e6e6e6ff"
            },
            'child-card-12': {
                "card_type": "TextCard",
                "region": {
                    "x": 400,
                    "y": -250,
                    "w": 200,
                    "h": 100,
                    "mask": 'rectangle',
                },
                "text": "I am another child 2 of 2 the CompositeCard.",
                "font_size": 10,
                "justification_horizontal": "center",
                "justification_vertical": "center",
                "text_color": "#000000ff",
                "background_color": "#e6e6e6ff"
            },
        }
    }

    const multiSelectSensor = {
        sensor_type: "MultiSelectSensor",
        choices: {
            "hello-image": {
                "card_type": "ImageCard",
                "region": {
                    "x": 0,
                    "y": 0,
                    "w": 100,
                    "h": 200,
                    "mask": 'rectangle',
                },
                "image": {
                    "sha256": 'yo',
                    "media_type": "image/png",
                    "locator": {
                        "locator_type": 'RelativePath',
                        "relative_path": "./assets/image/png/f66018c63e5de97a4a022f8d0da2083d44a842abcc27195b6cca13980a77dc7b.png"
                    }
                },
            },
            "hello-text": {
                "card_type": "TextCard",
                "region": {
                    "x": -300,
                    "y": -300,
                    "w": 200,
                    "h": 100,
                    "mask": 'rectangle',
                },
                "text": "I am a TextCard.",
                "font_size": 30,
                "justification_horizontal": "center",
                "justification_vertical": "center",
                "text_color": "#000000ff",
                "background_color": "#e6e6e6ff"
            },
            "text2": {
                "card_type": "TextCard",
                "region": {
                    "x": 300,
                    "y": -300,
                    "w": 100,
                    "h": 100,
                    "mask": 'rectangle',
                },
                "text": "I am a TextCard2.",
                "font_size": 10,
                "justification_horizontal": "center",
                "justification_vertical": "center",
                "text_color": "#000000ff",
                "background_color": "#e6e6e6ff"
            },
            "choice3": compositeCard2,
        },
        min_selections: 2,
        max_selections: null,
        confirm_button: {
            "card_type": "TextCard",
            "region": {
                "x": 0,
                "y": -200,
                "w": 200,
                "h": 50,
                "mask": 'rectangle',
            },
            "text": "Done",
            "font_size": 0.03,
            "justification_horizontal": "center",
            "justification_vertical": "center",
            "text_color": "#ffffffff",
            "background_color": "green"
        }
    }

    const textEntrySensor = {
        "sensor_type": "TextEntrySensor",
        "prompt": "I am a TextEntrySensor.",
        "font_size": 20,
        "min_length": 1,
        "max_length": null,
        "region": {
            'x': 0,
            'y': 250,
            'w': 750,
            'h': 250,
            'mask': 'rectangle',
        },
    }

    const sliderSensorH = {
        "sensor_type": 'SliderSensor',
        "num_bins": 5,
        "show_bin_markers": true,
        "initial_bin_index": 2,
        "orientation": 'horizontal',
        'region': {
            'x': 250,
            'y': 250,
            'w': 300,
            'h': 100,
            'mask': 'rectangle',
        }
    }
    const sliderSensorV = {
        "sensor_type": 'SliderSensor',
        "num_bins": 100,
        "show_bin_markers": false,
        "initial_bin_index": 2,
        "orientation": 'vertical',
        'region': {
            'x': -450,
            'y': 250,
            'w': 50,
            'h': 500,
            'mask': 'rectangle',
        }
    }
    const productSensor = {
        "sensor_type": "ProductSensor",
        "children": {
            //'child-sensor1': textEntrySensor,
            //'select3': multiSelectSensor,
            'slider': sliderSensorH,
            //'sliderV': sliderSensorV,
        }
    }

    const videoCard = {
        "card_type": "VideoCard",
        "region": {
            "x": 250,
            "y": 0,
            "w": 200,
            "h": 200,
            "mask": 'ellipse',
        },
        "video": {
            "sha256": "3f224a8b6a7917ae1364cf2cc9daf7a5f7073bfe0fb5d9b638d8a6efc1c867f7",
            "media_type": "video/mp4",
            "locator": {
                "locator_type": "RelativePath",
                "relative_path": "assets/video/mp4/3f224a8b6a7917ae1364cf2cc9daf7a5f7073bfe0fb5d9b638d8a6efc1c867f7.mp4"
            }
        },
        "loop": false
    }
    const compositeCard = {
        "card_type": "CompositeCard",
        "children": {
            'child-card-1': videoCard,
            'text-card': {
                "card_type": "TextCard",
                "region": {
                    "x": -300,
                    "y": 0,
                    "w": 200,
                    "h": 100,
                    "mask": 'rectangle',
                },
                "text": "I am a **TextCard** inside a CompositeCard.",
                "font_size": 14,
                "justification_horizontal": "center",
                "justification_vertical": "center",
                "text_color": "#000000ff",
                "background_color": "#e6e6e6ff"
            }
        }
    }

    let devGraph = {
        'type': 'Graph',
        "start": "my-node",
        "nodes": {
            "my-node": {
                "type": 'Node',
                "stimulus": compositeCard,
                "sensor": productSensor,
                "board_color": "white",
                "show_pointer": true,
            },
        },
        "transitions": {
            'my-node': {
                'transition_type': 'End',
                'register_updates': {}
            },
        },
        "nodekit_version": "0.1.0",
        'registers': {},
    }

    import {play, getSubmissionTarget, submit} from '/src/main.ts';

    window.focus();

    window.onload = async () => {
        try {
            const submissionTarget = getSubmissionTarget();
            console.log('Submission target', submissionTarget)

            let trace = await play(
                devGraph,
                (event) => {
                    // Avoid noise in the log
                    if ("PointerSampledEvent" === event.event_type) {
                        return;
                    }
                    console.log(event);
                },
                false,
            );
            console.log('Trace', trace);

            submit(trace, submissionTarget)

        } catch (err) {
            console.error('Dev harness failed to play graph', err);
        }
    };
</script>

</body>
</html>
