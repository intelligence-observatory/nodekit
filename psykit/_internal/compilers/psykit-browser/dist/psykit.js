(function(n,t){typeof exports=="object"&&typeof module<"u"?t(exports):typeof define=="function"&&define.amd?define(["exports"],t):(n=typeof globalThis<"u"?globalThis:n||self,t(n.EventClient={}))})(this,(function(n){"use strict";var l=Object.defineProperty;var h=(n,t,o)=>t in n?l(n,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[t]=o;var u=(n,t,o)=>h(n,typeof t!="symbol"?t+"":t,o);class t{constructor(e,s){u(this,"connectionUrl");u(this,"queue",[]);u(this,"flushing",!1);u(this,"runId");this.connectionUrl=s,this.runId=e}async queueEvent(e){return new Promise((s,i)=>{this.queue.push({event:e,resolve:s,reject:i}),this._maybeFlushNext()})}async sendEventCore(e){var a;const s=new AbortController,i=await fetch(this.connectionUrl,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"},signal:((a=AbortSignal.timeout)==null?void 0:a.call(AbortSignal,8e3))??s.signal,keepalive:!0});let r=null;if(i.ok){const d=i.headers.get("content-type")||"";i.status!==204&&d.includes("application/json")&&(r=await i.json())}else console.error("Failed to post event:",i.status,i.statusText);return{response:r,status:i.status,ok:i.ok}}getTimestamp(){return new Date().toISOString()}_maybeFlushNext(){if(this.flushing)return;const e=this.queue.shift();e&&(this.flushing=!0,this.sendEventCore(e.event).then(s=>{s.ok?e.resolve(s):this.queue.unshift(e)}).catch(s=>{console.warn("Fetch error, requeuing:",s),this.queue.unshift(e)}).finally(()=>{this.flushing=!1,this._maybeFlushNext()}))}getEventId(){return crypto.randomUUID()}async sendStartEvent(){let e={run_id:this.runId,event_id:this.getEventId(),event_type:"StartEvent",event_payload:{},event_timestamp:this.getTimestamp()};return this.queueEvent(e)}async sendNodeResultEvent(e){const s={run_id:this.runId,event_id:this.getEventId(),event_type:"NodeResultEvent",event_payload:e,event_timestamp:this.getTimestamp()};return this.queueEvent(s)}async sendEndEvent(){let e={run_id:this.runId,event_id:this.getEventId(),event_type:"EndEvent",event_payload:{},event_timestamp:this.getTimestamp()};return this.queueEvent(e)}}typeof window<"u"&&(window.EventClient=t),n.EventClient=t,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})}));
