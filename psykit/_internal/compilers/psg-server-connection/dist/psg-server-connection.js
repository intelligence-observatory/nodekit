(function(s,n){typeof exports=="object"&&typeof module<"u"?n(exports):typeof define=="function"&&define.amd?define(["exports"],n):(s=typeof globalThis<"u"?globalThis:s||self,n(s.PsgServerConnection={}))})(this,function(s){"use strict";var c=Object.defineProperty;var h=(s,n,o)=>n in s?c(s,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[n]=o;var u=(s,n,o)=>h(s,typeof n!="symbol"?n+"":n,o);class n{constructor(e){u(this,"connectionUrl");u(this,"queue",[]);u(this,"flushing",!1);this.connectionUrl=e}async queueEvent(e){return new Promise((t,i)=>{this.queue.push({event:e,resolve:t,reject:i}),this._maybeFlushNext()})}async sendEventCore(e){var a;let t=await fetch(this.connectionUrl,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}}),i={};t.ok?(a=t.headers.get("content-type"))!=null&&a.includes("application/json")?i=await t.json():console.error("Response is not JSON:",t.headers.get("content-type")):console.error("Failed to post event:",t.status,t.statusText);const r={response:i,status:t.status,ok:t.ok};return console.log("Sent:",e,"Received:",r),r}getTimestamp(){return new Date().toISOString()}_maybeFlushNext(){if(this.flushing)return;const e=this.queue.shift();e&&(this.flushing=!0,this.sendEventCore(e.event).then(t=>{t.ok?e.resolve(t):this.queue.unshift(e)}).catch(t=>{console.warn("Fetch error, requeuing:",t),this.queue.unshift(e)}).finally(()=>{this.flushing=!1,this._maybeFlushNext()}))}async sendStartEvent(){return await this.queueEvent({event_code:"START",event_timestamp:this.getTimestamp()})}async sendReportEvent(e){const t={event_code:"REPORT",event_data:JSON.stringify(e),event_timestamp:this.getTimestamp()};return new Promise((i,r)=>{this.queue.push({event:t,resolve:i,reject:r}),this._maybeFlushNext()})}async sendEndEvent(){let e=await this.queueEvent({event_code:"END",event_timestamp:this.getTimestamp()});if(e.response.redirect_url)return e.response.redirect_url}}typeof window<"u"&&(window.PsgServerConnection=n),s.PsgServerConnection=n,Object.defineProperty(s,Symbol.toStringTag,{value:"Module"})});
